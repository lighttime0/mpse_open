# MPSE 整体概述

## 1 程序分析，符号执行与Klee

### 1.1 程序分析

程序分析是用某些方法对已有的程序进行自动或者半自动的分析，来对程序进行缺陷检测、性能测试等，来帮助开发人员将程序修改地更高效、更鲁棒。

### 1.2 符号执行

静态分析、动态分析和符号执行是程序分析领域最常见的三类方法。

#### 1.2.1 符号执行概述

符号执行在结构上非常类似于一个编译器的后端。以Klee为例，Klee以LLVM IR文件为输入，对每条指令进行翻译和处理，这样一来所有变量的值就能实时记录下来。

符号执行最关键的地方在于将某些变量符号化，在Klee执行的过程中记录所有和这个符号量相关的约束条件，在一条路径结束时用求解器来求解。

#### 1.2.1 符号执行优缺点

符号执行这类方法的优点包括：

（1）可以遍历程序的所有执行路径；

（2）有考虑到变量取值，通过约束的办法来实现0误报率。

缺点主要是效率问题，因为符号执行遍历所有代码路径，会产生路径爆炸。

### 1.3 Klee

Klee是符号执行领域最经典的项目，几乎所有的符号执行项目要么以Klee为基础进行修改和优化，要么以Klee为对比。



## 2 Klee对库函数的支持，以及MPSE的目标

### 2.1 Klee中如何处理库函数

实际的应用程序中，绝大部分都会用到库函数，最常见的库就是运行时库。库其实是一组目标文件的包，并不是源代码，所以Klee在遇到对库函数的调用时，没办法进行自己进行翻译，这时候Klee有两种策略：

（1）如果这个库函数的调用输入不包括符号量，且这个函数的执行对符号量没有影响，则直接调用外部库去执行，比如printf一个非符号量。

（2）对这个库函数进行建模，模拟真实库函数的执行，并执行这段建模后的代码。比如memcpy函数，Klee就简单实现了这个函数，当应用程序调用memcpy时，不会进入库函数执行，而是跳到Klee对memcpy的实现代码中去执行。

如果以上两种策略都不能使用的话，Klee就会报错：“遇到无法处理的外部函数调用”。

### 2.2 MPSE的目标

多线程编程在如今已经非常普及了，但是Klee对pthread_create、phthread_join这些库函数并没有支持。MPSE的目标就是在Klee的基础上增加pthread库函数的支持。



## 3 相关工作

### 3.1 Cloud9

Cloud9是2011年发表的一篇论文，这篇论文的主要贡献包括：

（1）分布式符号执行。可以将符号执行部署在分布式环境下，在多台机器上同时执行符号执行。

（2）增加对fork、pthread_xxx等函数的建模；增加pipe、event等机制的建模。具体来说，就是在符号执行的过程中，对每个线程的相关信息记录到ExecutionState中，继承之前的约束后，对每个线程单独记录约束条件，并求解。

### 3.2 Klee

Klee是2008年发表的一篇论文，在符号执行领域影响深远。

Klee目前还在不断更新中。



## 4 MPSE整体思路

MPSE目前的工作是将Cloud9中多线程部分移植到Klee-1.4上，整体思路是：

（1）以Klee-1.4为base，接口有冲突的时候尽量以Klee-1.4的代码为基准。Cloud9对代码的Redistribution也尽量去掉，以Klee-1.4的distirbution为基准。

（2）分布式符号执行部分的代码尽量剔除掉，减少潜在的bug。

（3）runtime/POSIX中和多线程支持无关的，且比较复杂的代码，暂时不动。这部分代码Cloud9改的面目全非了，移植的话耗时较多，但是增加的功能也就只有socket和pipe的支持，所以目前先不动这块的代码，直接用Klee-1.4的代码。



## 5 Klee的代码框架以及MPSE对Klee的改动

Klee中核心的代码模块包括以下几部分，MPSE对这些模块做了一些修改。

#### （1）ExecutionState

Klee运行的过程中，ExecutionState类表示一条执行路径。ExecutionState类会记录符号执行的一些状态，比如当前执行的指令指针、栈帧、约束集、求解时间、符号量等等。

多线程模型中，每个线程都有自己的pc和栈帧，所以Cloud9将这些数据移到了Thread类中。

#### （2）Executor

Klee的核心执行模块，类似于一个以IR为输入的LLVM编译器后端。Executor中将各种指令进行处理，在执行的过程中，记录和符号量相关的约束。

Cloud9做的修改是将pc和栈帧等改成从线程中取数据。

#### （3）runtime

Klee中对外部库函数建模的模块，包含Klee可以支持的外部库函数的建模。Klee遇到外部库函数时，会先进入这里，对外部库函数进行解析和处理。

对多线程函数的建模就放在这里。





































